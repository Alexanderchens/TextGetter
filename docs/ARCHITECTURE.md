# TextGetter - 多模态视频文案提取工具 - 系统架构设计

## 一、项目概述

**目标**：从各大短视频平台的视频中逆向提取文案内容，支持知识归纳与总结。

**核心能力**：
- 支持多平台视频/图文内容输入
- 自动识别平台来源
- 多模态方式提取文案（语音、字幕、OCR、画面文字等）
- 统一前端交互体验

---

## 二、整体架构图

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           统一前端 (Unified Frontend)                         │
│  ┌──────────────┐ ┌──────────────┐ ┌──────────────┐ ┌──────────────────────┐ │
│  │  链接粘贴区   │ │  文件上传区   │ │  历史记录    │ │  导出/总结/知识库     │ │
│  └──────────────┘ └──────────────┘ └──────────────┘ └──────────────────────┘ │
└─────────────────────────────────────────────────────────────────────────────┘
                                        │
                                        ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                           网关层 (API Gateway)                                │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │  REST API / 任务队列 / WebSocket (实时进度)                            │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────────────────────────┘
                                        │
          ┌─────────────────────────────┼─────────────────────────────┐
          ▼                             ▼                             ▼
┌─────────────────────┐   ┌─────────────────────┐   ┌─────────────────────────────┐
│   平台识别解析器      │   │   任务编排调度器      │   │   多模态文案提取引擎        │
│  Platform Parser     │   │   Task Orchestrator   │   │   Content Extractor        │
│                     │   │                     │   │                             │
│ • URL 解析          │   │ • 任务拆分           │   │ ┌─────────────────────────┐ │
│ • 平台识别          │   │ • 并发控制           │   │ │  ASR (语音转文字)         │ │
│ • 元数据抽取        │   │ • 重试/降级          │   │ │  Whisper / FunASR        │ │
│ • 媒体下载          │   │ • 进度回调           │   │ └─────────────────────────┘ │
└─────────────────────┘   └─────────────────────┘   │ ┌─────────────────────────┐ │
          │                             │            │ │  OCR (画面文字识别)       │ │
          │                             │            │ │  PaddleOCR / EasyOCR     │ │
          └─────────────────────────────┼────────────│ └─────────────────────────┘ │
                                        │            │ ┌─────────────────────────┐ │
                                        │            │ │  字幕解析 (SRT/VTT)      │ │
                                        │            │ └─────────────────────────┘ │
                                        │            │ ┌─────────────────────────┐ │
                                        │            │ │  LLM 清洗与去重合并       │ │
                                        │            │ └─────────────────────────┘ │
                                        │            └─────────────────────────────┘
                                        │                             │
                                        ▼                             ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                           平台适配器层 (Platform Adapters)                    │
│  ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐             │
│  │ 抖音     │ │ 快手     │ │ B站      │ │ 小红书   │ │ 视频号   │  ...         │
│  │ Douyin   │ │ Kuaishou │ │ Bilibili │ │ Xiaohs   │ │ WeChat   │             │
│  └──────────┘ └──────────┘ └──────────┘ └──────────┘ └──────────┘             │
└─────────────────────────────────────────────────────────────────────────────┘
                                        │
                                        ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                           数据层 (Data Layer)                                 │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐       │
│  │ 任务记录 DB  │  │ 提取结果 DB  │  │ 媒体缓存     │  │ 知识库/向量  │       │
│  │ (SQLite/PG)  │  │ (文档存储)   │  │ (本地/OSS)   │  │ (可选)       │       │
│  └──────────────┘  └──────────────┘  └──────────────┘  └──────────────┘       │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 三、核心模块设计

### 3.1 统一前端 (Unified Frontend)

**技术选型建议**：React/Vue + Tailwind + 本地优先设计（可选 Electron 桌面版）

**功能模块**：

| 功能 | 描述 |
|------|------|
| 链接粘贴 | 支持粘贴各平台视频链接，自动识别并提取 |
| 文件上传 | 支持本地视频/图片上传（处理已下载内容） |
| 提取进度 | 实时显示下载、转码、ASR、OCR 等阶段进度 |
| 文案展示 | 分段展示提取结果，支持来源标注（语音/字幕/OCR） |
| 编辑与合并 | 手动合并、去重、润色文案 |
| 导出 | Markdown / TXT / Notion 等导出 |
| 知识归纳 | 对接 LLM 做摘要、大纲、知识卡片（可选） |

---

### 3.2 平台解析器 (Platform Parser)

**职责**：从输入（URL / 文件）识别平台，并获取可处理的媒体资源。

**输入**：
- 视频链接（如 `https://www.douyin.com/video/xxx`）
- 本地视频/图片文件

**输出**：
- 平台标识（`douyin` / `bilibili` / `xiaohongshu` / `local` 等）
- 视频/图片 URL 或本地路径
- 元数据（标题、发布时间、作者等，若可获取）

**平台识别逻辑**：

```python
# 伪代码示例
PLATFORM_PATTERNS = {
    "douyin": [r"douyin\.com", r"iesdouyin\.com"],
    "bilibili": [r"bilibili\.com", r"b23\.tv"],
    "kuaishou": [r"kuaishou\.com", r"v\.kuaishou\.com"],
    "xiaohongshu": [r"xiaohongshu\.com", r"xhslink\.com"],
    "weixin": [r"mp\.weixin\.qq\.com", r"channels\.weixin\.qq\.com"],
    "local": []  # 本地文件
}

def detect_platform(input: str) -> PlatformInfo:
    if is_local_file(input):
        return PlatformInfo(platform="local", media_path=input)
    for platform, patterns in PLATFORM_PATTERNS.items():
        if any(re.search(p, input) for p in patterns):
            return parse_and_fetch(platform, input)
    raise UnsupportedPlatformError(input)
```

**各平台适配要点**：

| 平台 | 难点 | 策略 |
|------|------|------|
| 抖音 | 反爬、水印、无直接下载 | 第三方解析 API / yt-dlp 等 |
| B站 | 有字幕接口 | 优先获取 CC 字幕，无则 ASR |
| 小红书 | 图文为主 | 图片 OCR + 正文爬取 |
| 视频号 | 封闭生态 | 依赖用户录屏上传 |

---

### 3.3 多模态文案提取器 (Content Extractor)

**目标**：从视频/图片中提取所有可读文字信息，并合并为连贯文案。

**多模态流水线**：

```
输入: 视频/图片
    │
    ├─► [1] 字幕轨道解析 ──► 有字幕？ ──► 直接提取（SRT/VTT/内嵌）
    │
    ├─► [2] 语音轨道 ─────► ASR (Whisper / FunASR) ─► 时间轴文本
    │
    ├─► [3] 视频帧 ───────► 关键帧采样 ─► OCR (PaddleOCR / EasyOCR) ─► 画面文字
    │
    └─► [4] 合并去重 ─────► LLM 清洗、按时间排序、去重、生成最终文案
```

**技术选型**：

| 能力 | 推荐方案 | 说明 |
|------|----------|------|
| ASR | Whisper (OpenAI) | 多语言、效果好；可本地部署 large-v3 |
| ASR 替代 | FunASR | 中文优化，阿里开源 |
| OCR | PaddleOCR | 中文场景表现好，可离线 |
| OCR 替代 | EasyOCR | 多语言，部署简单 |
| 字幕解析 | ffmpeg / youtube-dl 等 | 提取内嵌或外挂字幕 |
| 清洗合并 | LLM (本地/API) | 去重、排序、润色 |

**合并策略**：
- 按时间轴对齐：ASR 与 OCR 结果带时间戳，可重叠合并
- 去重：编辑距离 / 语义相似度去重
- 优先级：字幕 > ASR > OCR（因字幕通常更准确）

---

### 3.4 任务编排与调度

- **任务类型**：单链接提取、批量提取、历史重试
- **队列**：Redis / 内存队列，支持异步与进度回调
- **并发**：按平台限速，避免触发反爬
- **重试**：下载失败、解析失败时有限次重试
- **降级**：某平台解析失败时，可提示用户上传本地文件

---

## 四、数据流示例

```
用户粘贴: https://www.bilibili.com/video/BV1xx411c7mD
    │
    ▼
[平台解析] 识别为 B站 → 获取视频流 URL、字幕 URL
    │
    ▼
[媒体下载] 下载视频 + 字幕（若有）
    │
    ▼
[提取流水线]
    • 字幕: 直接解析 SRT → 文本 A
    • ASR: 若无字幕，对音频做 Whisper → 文本 B
    • OCR: 每秒 1 帧采样 → 文本 C
    │
    ▼
[合并] A + B + C → 按时间轴合并、去重
    │
    ▼
[LLM 清洗] 可选：润色、分段、加标题
    │
    ▼
[存储] 写入 DB，返回前端展示
```

---

## 五、技术栈建议

| 层级 | 推荐技术 |
|------|----------|
| 前端 | React + Vite + Tailwind | 或 Vue 3 + Nuxt |
| 后端 | FastAPI (Python) | 便于集成 ML/多模态 |
| 任务队列 | Celery + Redis | 或 ARQ |
| 数据库 | SQLite (轻量) / PostgreSQL (生产) | |
| 媒体处理 | ffmpeg, yt-dlp | |
| ASR | Whisper / FunASR | |
| OCR | PaddleOCR | |
| 部署 | Docker Compose | 一键本地部署 |

---

## 六、扩展与优化

1. **平台扩展**：新增平台时，实现 `PlatformAdapter` 接口，注册到解析器即可
2. **提取策略配置**：按平台配置是否用 ASR/OCR/字幕，以及采样帧率
3. **知识库**：可选接入向量数据库，对提取文案做索引，支持语义检索与归纳
4. **合规**：仅用于个人学习，注意版权与平台 ToS，建议支持「仅本地处理」模式

---

## 七、模块详细设计

各核心模块的详细设计文档位于 [docs/design/](design/README.md)，包括：

- **01-frontend**：前端页面结构、组件、状态、API
- **02-platform-parser**：平台解析器接口与调度
- **03-content-extractor**：字幕/ASR/OCR/合并器实现细节
- **04-task-orchestrator**：任务状态机、队列、重试
- **05-platform-adapters**：各平台适配器实现要点
- **06-data-layer**：数据库表、Repository、缓存
- **07-api-gateway**：REST API、WebSocket、错误规范

---

## 八、目录结构建议

```
TextGetter/
├── frontend/                 # 统一前端
│   ├── src/
│   │   ├── components/
│   │   ├── pages/
│   │   └── api/
│   └── package.json
├── backend/                  # 后端服务
│   ├── app/
│   │   ├── api/              # REST 接口
│   │   ├── parsers/          # 平台解析器
│   │   │   ├── base.py
│   │   │   ├── douyin.py
│   │   │   ├── bilibili.py
│   │   │   └── ...
│   │   ├── extractors/       # 文案提取器
│   │   │   ├── asr.py
│   │   │   ├── ocr.py
│   │   │   ├── subtitle.py
│   │   │   └── merger.py
│   │   ├── tasks/            # 异步任务
│   │   └── models/           # 数据模型
│   ├── requirements.txt
│   └── Dockerfile
├── docker-compose.yml
├── docs/
│   └── ARCHITECTURE.md
└── README.md
```

---

## 九、风险与对策

| 风险 | 对策 |
|------|------|
| 平台反爬 | 限速、代理轮换、优先支持「用户上传」 |
| 版权 | 明确仅供个人学习，不对外传播 |
| 提取质量 | 多源合并 + LLM 清洗，提供人工编辑 |
| 成本 | ASR/LLM 可选用本地模型，降低 API 费用 |
